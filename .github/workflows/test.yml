name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '23'

      - uses: pnpm/action-setup@v4
        with:
          version: latest

      # Install root dependencies
      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      # Install tests workspace deps ONLY if tests/ tiene package.json
      - name: Install test project deps
        if: hashFiles('tests/package.json') != ''
        run: cd tests && pnpm install --no-frozen-lockfile

      # Run tests (usa tu script en package.json)
      - name: Run Tests
        run: |
          pnpm test || {
            echo "Tests failed. Dumping first 200 lines of report:"
            sed -n '1,200p' tests/html/test-results.html || true
            exit 1
          }